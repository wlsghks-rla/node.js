<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <h3>파일업로드</h3>
    <div class="board">
      <!-- localhost:3000/index.htmml -->
      <!--글등록: localhost:3000/board/board -->
      <!-- localhost:3000/board/board?title=제목1&content=글쓰기연습 -->
      <!-- application/x-www-form-urlencoded 형식 -->
      <form action="board/board" class="addBoard" method="post">
        제목: <input type="text" name="title" /><br />
        내용: <textarea name="content"></textarea><br />
        작성자: <input type="text" name="author" /><br />
        파일: <input type="file" name="img" /><br />
        <input type="submit" value="등록" />
      </form>
    </div>

    <h3>FormData 활용</h3>
    <!-- 있는 형식 그대로 넘기는 거 가능 -->
    <div class="multi">
      <form
        action="board/board"
        class="multipart"
        method="post"
        enctype="multipart/form-data"
      >
        제목: <input type="text" name="title" /><br />
        내용: <textarea name="content"></textarea><br />
        작성자: <input type="text" name="author" /><br />
        파일: <input type="file" name="img" /><br />
        <input type="submit" value="등록" />
      </form>
    </div>

    <a href="bordList.html">게시글목록</a>

    <script>
      // multipart요청 FormData 객체.
      document
        .querySelector("form.multipart")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          let file = document.querySelector(
            'form.multipart input[type="file"]'
          );
          console.log(file.files[0]);

          const title = document.querySelector(
            'form.multipart input[name = "title"]'
          ).value;
          const content = document.querySelector(
            'form.multipart textarea[name = "content"]'
          ).value;
          const author = document.querySelector(
            'form.multipart input[name = "author"]'
          ).value;
          if (!title || !content || !author) {
            alert("필수값은 입력!!");
            return;
          }
          const formData = new FormData(); // form 데이터를 처리(multipart)
          formData.append("title", title);
          formData.append("content", content);
          formData.append("author", author);
          formData.append("img", file.files[0]);

          fetch("board/board", {
            method: "post",
            // headers 필요 x
            body: formData,
          })
            .then((resp) => resp.json)
            .then((result) => {
              console.log(result);
            })
            .catch((err) => console.log(err));
        });

      // 이벤트.
      let filename = "";
      let base64 = "";
      document
        .querySelector('input[type="file"]')
        .addEventListener("change", (e) => {
          console.log(e.target.files[0]);
          const file = e.target.files[0]; // binary -> text(base64)
          filename = file.name; // 레드향.jpg
          // 파일처리객체.
          const reader = new FileReader();
          reader.onload = function () {
            console.log(reader.result);
            base64 = reader.result.split(",")[1];
          };
          reader.readAsDataURL(file); // 파일 읽는 함수.
        });
      // localhost:3000/board/board?title=제목1&content=글쓰기연습 -> json형식으로 변경해야함.
      document
        .querySelector("form.addBoard")
        .addEventListener("submit", (e) => {
          e.preventDefault(); // form의 submit기능 차단.
          const title = document.querySelector('input[name = "title"]').value;
          const content = document.querySelector(
            'textarea[name = "content"]'
          ).value;
          const author = document.querySelector('input[name = "author"]').value;
          if (!title || !content || !author) {
            alert("필수값은 입력!!");
            return;
          }
          // 서버프로그램 호출
          fetch("board/board", {
            method: "post",
            headers: { "Content-Type": "application/json;charset=utf-8" },
            body: JSON.stringify({
              title,
              content,
              author,
              filename,
              base64,
            }),
          })
            // .then((resp) => resp.json())
            // .then((result) => {
            //   if (result.retCode == "OK") {
            //     alert(result.retVal);
            //   } else {
            //     alert(result.retVal);
            //   }
            .then((resp) => resp.text())
            .then((result) => {
              alert(result);
            });
        });
    </script>
  </body>
</html>
